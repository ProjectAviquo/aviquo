{% extends 'base.html' %}
{% block title %}Extracurricular Database{% endblock %}

{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/custom.css' %}">
<section class="section">
  <div class="container">
    <h1 class="title" style="color: #333;">Extracurricular Opportunities</h1>

    <div class="container is-fluid">
        <div class="columns">
            <div class="column is-one-quarter">
                <aside class="menu">
                    <ul class="menu-list">
                        {% for tag in all_tags %}
                            <li>
                                <a href="?{% if tag.name in active_tags %}remove{% else %}add{% endif %}_tag={{ tag.name }}" class="{% if tag.name in active_tags %}is-active{% endif %}">
                                    {{ tag.name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </aside>
            </div>
            <div class="column">
                <!-- Search bar and filter button -->
                <form method="get" action="{% url 'opportunity' %}">
                    {{ form.as_p }}
                    <button type="submit" class="button is-primary">Filter</button>
                </form>
        </div>
    </div>

    <!-- Include this script at the bottom of the `opportunity_list.html` file -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Attach click event to tag links
        document.querySelectorAll('aside.menu a').forEach((tagLink) => {
            tagLink.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent the default anchor link behavior

                // Parse the URL query parameters
                let urlParams = new URLSearchParams(window.location.search);

                // Check whether we're adding or removing a tag
                const tagName = e.target.getAttribute('href').split('=').pop();
                if (e.target.getAttribute('href').startsWith('?add_tag')) {
                    urlParams.append('tags', tagName);
                } else {
                    let tags = urlParams.getAll('tags');
                    tags = tags.filter((tag) => tag !== tagName);
                    urlParams.delete('tags');
                    tags.forEach((tag) => urlParams.append('tags', tag));
                }

                // Redirect to the updated URL with the new set of active tags
                window.location.search = urlParams.toString();
            });
        });
    });
    </script>

    <!-- Opportunities list -->
    <div class="columns is-multiline">
    {% for opportunity in opportunities %}
        <div class="column is-one-third">
        <div class="card white-bg">
            <div class="card-content">
            <p class="title is-4">{{ opportunity.name }}</p>
            <p class="subtitle is-6">{{ opportunity.description|truncatewords:20 }}</p>
            </div>
            <footer class="card-footer">
            <a href="#" class="card-footer-item">Details</a>
            <a href="#" class="card-footer-item">Apply</a>
            <a href="?bookmark_opportunity={{ opportunity.id }}" class="card-footer-item {% if request.user in opportunity.bookmarked_users.all %}bookmarked{% endif %}">
            {% if request.user in opportunity.bookmarked_users.all %}Remove Bookmark{% else %}Bookmark{% endif %}
            </a>
        </footer>
      </div>
    </div>
    {% empty %}
    <p>No opportunities to display.</p>
    {% endfor %}
  </div>
</section>

<a href="?show_bookmarked" class="button is-primary {% if 'show_bookmarked_toggle' in request.session %}is-active{% endif %}">
    {% if 'show_bookmarked_toggle' in request.session %}Showing Bookmarked Extracurriculars{% else %}Showing All Extracurriculars{% endif %}
</a>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Attach click event to tag links
        document.querySelectorAll('aside.menu a').forEach((tagLink) => {
            tagLink.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent the default anchor link behavior

                // Parse the URL query parameters
                let urlParams = new URLSearchParams(window.location.search);

                // Check whether we're adding or removing a tag
                const tagName = e.target.getAttribute('href').split('=').pop();
                if (e.target.getAttribute('href').startsWith('?add_tag') && !urlParams.getAll('tags').includes(tagName)) {
                    urlParams.append('tags', tagName);
                } else {
                    let tags = urlParams.getAll('tags');
                    tags = tags.filter((tag) => tag !== tagName);
                    urlParams.delete('tags');
                    tags.forEach((tag) => urlParams.append('tags', tag));
                }

                // If 'show_bookmarked' was in the original parameters, make sure to include it in the updated parameters
                if (window.location.search.includes('show_bookmarked')) {
                    urlParams.append('show_bookmarked', '');
                }

                // Redirect to the updated URL with the new set of active tags
                window.location.search = urlParams.toString();
            });
        });
    });
    </script>

{% endblock %}